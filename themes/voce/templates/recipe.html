{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ SITEURL }}/theme/css/recipe.css">
    <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Recipe",
          "name": "{{ page.title|replace('&nbsp;', ' ')|striptags|e }}",
          "image": [
            "{{ SITEURL }}/{{ page.image }}"
          ],
          "author": {
            "@type": "Person",
            "name": "Josh Izaac"
          },
          "datePublished": "{{ page.date }}",
          "description": "{{ page.intro_html|striptags|truncate(160)|e }}",

          {% if page.time %}
          "totalTime": "PT{{ page.time|replace(' mins', 'M')|replace(' min', 'M')|replace(' hours', 'H') }}",
          {% endif %}

          "recipeYield": "{{ page.servings|default('4') }} servings",

          "recipeIngredient": [
            {% for ingredient in page.ingredients_list %}
            "{{ ingredient|e }}"{{ "," if not loop.last }}
            {% endfor %}
          ],

          "recipeInstructions": [
            {% for step in page.instructions_list %}
            {
              "@type": "HowToStep",
              "text": "{{ step|e }}"
            }{{ "," if not loop.last }}
            {% endfor %}
          ]
        }
    </script>
{% endblock %}

{% block metatitle %}{{ page.title|striptags|escape }} recipe | {{ SITENAME }}{% endblock %}
{% block title %}{{ page.title|striptags|escape }} recipe | {{ SITENAME }}{% endblock %}
{% block og_url %} {{ page.url }} {% endblock %}

{% block description %}
{% if page.description %}
{{ page.description }}
{% else %}
{{ page.intro_html|striptags|truncate(280)|escape }}
{% endif %}
{% endblock %}

{% block og_image %}{{ page.image if page.image else LOGO }}{% endblock %}

{% block masthead %}
{% endblock %}

{% block content %}

{% if page.sticky == "true" %}
<style>
@media (min-width: 768px) {
    .recipe-ingredients {
        /* Standard sticky positioning */
        position: -webkit-sticky; /* Safari support */
        position: sticky;

        /* Distance from the top of the viewport */
        top: 20px;

        /* Ensure it doesn't overlap weirdly */
        z-index: 10;

        /* Optional: limit height and scroll internal list if it's too long */
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
    .article-container {
        overflow: unset;
    }
}
</style>
{% endif %}

<article class="recipe-container">

    <header class="recipe-header">

        {% if page.image %}
        <div class="hero-image" style="background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{{ page.image }}');">
            <h1 class="recipe-title hero-text">{{ page.title }}</h1>
        </div>
        {% else %}
        <h1 class="recipe-title">{{ page.title }}</h1>
        {% endif %}

        <div class="recipe-meta-badges">
            {% if page.time %}
                <span>TIME</span><span>{{ page.time }}</span>
            {% endif %}
            {% if page.servings %}
                <span>MAKES</span><span id="servings-badge" data-original="{{ page.servings }}">{{ page.servings }}</span>
                <span class="scale-label">PORTION</span>
                <div class="scale-controls">
                    <a class="scale-btn" onclick="scaleRecipe(0.5, this)">0.5x</a>
                    <a class="scale-btn active" onclick="scaleRecipe(1, this)">1x</a>
                    <a class="scale-btn" onclick="scaleRecipe(2, this)">2x</a>
                    <a class="scale-btn" onclick="scaleRecipe(3, this)">3x</a>
                </div>
            {% endif %}
        </div>

        <div class="recipe-intro">
            {{ page.intro_html }}
        </div>
    </header>

    {% if page.timeline_parsed %}
    <div class="timeline-container collapsed" id="timeline-container">
        <h2 onclick="toggleTimeline()" class="timeline-header">Cooking Schedule<i class="timeline-arrow fas fa-angle-down"></i></h2>

        <div id="timeline-content">
<!--             <div class="timeline-controls">
                <label for="start-time-input" style="margin-bottom: 0;">Start at</label>
                <input type="time" id="start-time-input" value="09:00" oninput="updateTimeline()">
                <span class="finish-preview">
                    ready by <strong id="finish-time-display">--:--</strong>
                </span>
            </div> -->

            <div class="timeline-visual">
                {% for step in page.timeline_parsed %}
                <div class="timeline-step step-{{ step.type }}"
                     data-offset="{{ step.start_offset }}"
                     data-duration="{{ step.duration }}">

                    {% if loop.first %}
                    <input type="time" id="start-time-input" value="{{ page.timeline_start|default('09:00') }}" oninput="updateTimeline()">
                    <div class="step-time" style="display: none;">00:00</div>
                    {% else %}
                    <div class="step-time">00:00</div>
                    {% endif %}

                    <div class="step-marker">
                        <div class="marker-dot"></div>
                        <div class="marker-line"></div>
                    </div>

                    <div class="step-content">
                        <span class="step-name">{{ step.task }}</span>
                        <span class="step-duration">
                            {{ step.duration_display }}
                            {% if step.type == 'wait' %}(Passive){% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}

                <div class="timeline-step step-finish">
                    <div class="step-time" id="visual-finish-time">--:--</div>

                    <div class="step-marker">
                        <div class="marker-dot"></div>
                        </div>

                    <div class="step-content">
                        <span class="step-name">Finished!   </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Run once on load to set initial times
        document.addEventListener('DOMContentLoaded', () => updateTimeline());
    </script>
    {% endif %}

    <div class="recipe-grid">
        <section class="recipe-ingredients">
            <h2>INGREDIENTS</h2>
            {{ page.ingredients_html }}
        </section>

        <section class="recipe-method">
            <h2>STEPS</h2>
            {{ page.method_html }}
        </section>
    </div>

    {% if page.notes_html %}
    <div class="recipe-notes">
        <h2>NOTES</h2>
        {{ page.notes_html }}
    </div>
    {% endif %}

</article>

<script>
document.querySelectorAll('.recipe-ingredients li').forEach(li => {
    li.addEventListener('click', () => li.classList.toggle('done'));
});
</script>
<script>
function scaleRecipe(multiplier, btnElement) {
    // 1. Visuals: Update active button state
    document.querySelectorAll('.scale-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    btnElement.classList.add('active');

    // 2. Math: Update Ingredients
    document.querySelectorAll('.scalable').forEach(el => {
        const baseVal = parseFloat(el.dataset.base);
        if (!isNaN(baseVal)) {
            const newVal = baseVal * multiplier;

            // Format nicely: remove trailing zeros (e.g. 2.50 -> 2.5)
            // parseFloat(num.toFixed(2)) handles rounding to 2 decimal places
            // and stripping unnecessary zeros automatically.
            el.innerText = parseFloat(newVal.toFixed(2));
        }
    });

    // 3. Update Servings Badge
    const servBadge = document.getElementById('servings-badge');
    const baseServings = parseFloat(servBadge.dataset.original);
    if (!isNaN(baseServings)) {
        // Round to nearest whole number for servings
        servBadge.innerText = Math.round(baseServings * multiplier);
    }
}
</script>

<script>
document.querySelectorAll('.recipe-method li').forEach(li => {
    li.addEventListener('click', function() {
        const parent = this.parentNode;

        // If clicking the already highlighted item, turn off focus mode
        if (this.classList.contains('highlighted')) {
            this.classList.remove('highlighted');
            parent.classList.remove('focus-active');
        } else {
            // Remove highlight from others
            parent.querySelectorAll('li').forEach(el => el.classList.remove('highlighted'));

            // Highlight this one
            this.classList.add('highlighted');
            parent.classList.add('focus-active');
        }
    });
});
</script>

{% if page.timeline_parsed %}
<script>
function updateTimeline() {
    const input = document.getElementById('start-time-input');
    if (!input) return;

    const [startH, startM] = input.value.split(':').map(Number);
    const startTotalMins = (startH * 60) + startM;

    // Update Steps
    const steps = document.querySelectorAll('.timeline-step:not(.step-finish)');
    let lastOffset = 0;
    let lastDuration = 0;

    steps.forEach(step => {
        const offset = parseInt(step.dataset.offset);
        const duration = parseInt(step.dataset.duration);

        // Update the displayed time
        const timeDisplay = step.querySelector('.step-time');
        // We use innerHTML because we are adding a <span> tag
        timeDisplay.innerHTML = formatTimeWithDay(startTotalMins, offset);

        lastOffset = offset;
        lastDuration = duration;
    });

    // Update Finish Step
    const finishEl = document.getElementById('visual-finish-time');
    if (finishEl) {
        finishEl.innerHTML = formatTimeWithDay(startTotalMins, lastOffset + lastDuration);
    }
    const finishDisp = document.getElementById('finish-time-display');
    if (finishDisp) {
        finishDisp.innerHTML = formatTimeWithDay(startTotalMins, lastOffset + lastDuration);
    }
}

// Helper to format time with "+1 day" badges and convert "750 minutes" -> "12:30 PM"
function formatTimeWithDay(startTotalMins, totalMinutesFromStart) {
    const absoluteMins = startTotalMins + totalMinutesFromStart;

    // Calculate days passed
    // 1440 mins = 24 hours
    const daysPassed = Math.floor(absoluteMins / 1440);

    // Calculate clock time
    let currentMins = absoluteMins % 1440;
    let h = Math.floor(currentMins / 60);
    let m = currentMins % 60;

    const ampm = h >= 12 ? 'p.m.' : 'a.m.';

    h = h % 12;
    h = h ? h : 12; // the hour '0' should be '12'

    // Zero padding for minutes
    const mStr = m < 10 ? '0' + m : m;

    // Zero padding for hours
    const hStr = h < 10 ? '0' + h : h;

    let timeStr = `${hStr}:${mStr} ${ampm}`;

    // Append day badge if needed
    if (daysPassed > 0) {
        timeStr += ` <span class="day-badge">+${daysPassed}d</span>`;
    }

    return timeStr;
}

function toggleTimeline() {
    const box = document.getElementById('timeline-container');
    box.classList.toggle('collapsed');
}

</script>
{% endif %}
{% endblock %}
