{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ SITEURL }}/theme/css/recipe.css">
    <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Recipe",
          "name": "{{ page.title|replace('&nbsp;', ' ')|striptags|e }}",
          "image": [
            "{{ SITEURL }}/{{ page.image }}"
          ],
          "author": {
            "@type": "Person",
            "name": "Josh Izaac"
          },
          "datePublished": "{{ page.date }}",
          "description": "{{ page.intro_html|striptags|truncate(160)|e }}",

          {% if page.time %}
          "totalTime": "PT{{ page.time|replace(' mins', 'M')|replace(' min', 'M')|replace(' hours', 'H') }}",
          {% endif %}

          "recipeYield": "{{ page.servings|default('4') }} servings",

          "recipeIngredient": [
            {% for ingredient in page.ingredients_list %}
            "{{ ingredient|e }}"{{ "," if not loop.last }}
            {% endfor %}
          ],

          "recipeInstructions": [
            {% for step in page.instructions_list %}
            {
              "@type": "HowToStep",
              "text": "{{ step|e }}"
            }{{ "," if not loop.last }}
            {% endfor %}
          ]
        }
    </script>
{% endblock %}

{% block metatitle %}{{ page.title|striptags|escape }} recipe | {{ SITENAME }}{% endblock %}
{% block title %}{{ page.title|striptags|escape }} recipe | {{ SITENAME }}{% endblock %}
{% block og_url %} {{ page.url }} {% endblock %}

{% block description %}
{% if page.description %}
{{ page.description }}
{% else %}
{{ page.intro_html|striptags|truncate(280)|escape }}
{% endif %}
{% endblock %}

{% block og_image %}{{ page.image if page.image else LOGO }}{% endblock %}

{% block masthead %}
{% endblock %}

{% block content %}

{% if page.sticky == "true" %}
<style>
@media (min-width: 768px) {
    .recipe-ingredients {
        position: -webkit-sticky;
        position: sticky;
        top: 20px;
        z-index: 10;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
    .article-container {
        overflow: unset;
    }
}
</style>
{% endif %}

<article class="recipe-container">

    <header class="recipe-header">

        {% if page.image %}
        <div class="hero-image" style="background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{{ page.image }}');">
            <h1 class="recipe-title hero-text">{{ page.title }}</h1>
        </div>
        {% else %}
        <h1 class="recipe-title">{{ page.title }}</h1>
        {% endif %}

        <div class="recipe-meta-badges">
            {% if page.time %}
                <span>TIME</span><span>{{ page.time }}</span>
            {% endif %}
            {% if page.servings %}
                <span>MAKES</span><span id="servings-badge" data-original="{{ page.servings }}">{{ page.servings }}</span>
                <span class="scale-label">PORTION</span>
                <div class="scale-controls">
                    <a class="scale-btn" onclick="scaleRecipe(0.5, this)">0.5x</a>
                    <a class="scale-btn active" onclick="scaleRecipe(1, this)">1x</a>
                    <a class="scale-btn" onclick="scaleRecipe(2, this)">2x</a>
                    <a class="scale-btn" onclick="scaleRecipe(3, this)">3x</a>
                </div>
            {% endif %}
        </div>

        <div class="recipe-intro">
            {{ page.intro_html }}
        </div>
    </header>

    {% if page.timeline_parsed %}
    <div class="timeline-container collapsed" id="timeline-container">
        <h2 onclick="toggleTimeline()" class="timeline-header">Cooking Schedule<i class="timeline-arrow fas fa-angle-down"></i></h2>

        <div id="timeline-content">

            <div class="timeline-visual">
                {% for step in page.timeline_parsed %}
                <div class="timeline-step step-{{ step.type }}"
                     data-offset="{{ step.start_offset }}"
                     data-duration="{{ step.duration }}">

                    {% if loop.first %}
                    <input type="time" id="start-time-input" value="{{ page.timeline_start|default('09:00') }}" oninput="updateTimeline()">
                    <div class="step-time" style="display: none;">00:00</div>
                    {% else %}
                    <div class="step-time">00:00</div>
                    {% endif %}

                    <div class="step-marker">
                        <div class="marker-dot"></div>
                        <div class="marker-line"></div>
                    </div>

                    <div class="step-content">
                        <span class="step-name">{{ step.task }}</span>
                        <span class="step-duration">
                            ({{ step.duration_display }})
                            <!-- {% if step.type == 'wait' %}(Passive){% endif %} -->
                        </span>
                    </div>
                </div>
                {% endfor %}

                <div class="timeline-step step-finish">
                    <div class="step-time" id="visual-finish-time">--:--</div>

                    <div class="step-marker">
                        <div class="marker-dot"></div>
                        </div>

                    <div class="step-content">
                        <span class="step-name">Finished!   </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="recipe-grid">
        <section class="recipe-ingredients">
            <h2>INGREDIENTS</h2>
            {{ page.ingredients_html }}
        </section>

        <section class="recipe-method">
            <h2>STEPS</h2>
            {{ page.method_html }}
        </section>
    </div>

    {% if page.notes_html %}
    <div class="recipe-notes">
        <h2>NOTES</h2>
        {{ page.notes_html }}
    </div>
    {% endif %}

</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ingredientContainer = document.querySelector('.recipe-ingredients');

    if (ingredientContainer) {
        ingredientContainer.addEventListener('click', function(e) {
            const li = e.target.closest('li');

            // If we didn't click inside an li, or we clicked the container padding, ignore.
            if (!li) return;

            // check if the user clicked an interactive element
            if (e.target.closest('a')) {
                return;
            }

            li.classList.toggle('done');
        });
    }
});
</script>

<script>
function scaleRecipe(multiplier, btnElement) {
    document.querySelectorAll('.scale-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    btnElement.classList.add('active');

    document.querySelectorAll('.scalable').forEach(el => {
        const baseVal = parseFloat(el.dataset.base);
        if (!isNaN(baseVal)) {
            const newVal = baseVal * multiplier;

            // Remove trailing zeros (e.g. 2.50 -> 2.5)
            // parseFloat(num.toFixed(2)) handles rounding to 2 decimal places
            // and stripping unnecessary zeros automatically.
            el.innerText = parseFloat(newVal.toFixed(2));
        }
    });

    // update Servings Badge
    const servBadge = document.getElementById('servings-badge');
    const baseServings = parseFloat(servBadge.dataset.original);
    if (!isNaN(baseServings)) {
        // Round to nearest whole number for servings
        servBadge.innerText = Math.round(baseServings * multiplier);
    }
}
</script>

<script>
document.querySelectorAll('.recipe-method li').forEach(li => {
    li.addEventListener('click', function() {
        const parent = this.parentNode;

        // if clicking the already highlighted item, turn off focus mode
        if (this.classList.contains('highlighted')) {
            this.classList.remove('highlighted');
            parent.classList.remove('focus-active');
        } else {
            // remove highlight from others
            parent.querySelectorAll('li').forEach(el => el.classList.remove('highlighted'));

            // highlight this one
            this.classList.add('highlighted');
            parent.classList.add('focus-active');
        }
    });
});
</script>

{% if page.timeline_parsed %}
<script>
function updateTimeline() {
    const input = document.getElementById('start-time-input');
    if (!input) return;

    const [startH, startM] = input.value.split(':').map(Number);
    const startTotalMins = (startH * 60) + startM;

    const steps = document.querySelectorAll('.timeline-step:not(.step-finish)');
    let lastOffset = 0;
    let lastDuration = 0;

    steps.forEach(step => {
        const offset = parseInt(step.dataset.offset);
        const duration = parseInt(step.dataset.duration);

        const timeDisplay = step.querySelector('.step-time');
        // We use innerHTML because we are adding a <span> tag
        timeDisplay.innerHTML = formatTimeWithDay(startTotalMins, offset);

        lastOffset = offset;
        lastDuration = duration;
    });

    const finishEl = document.getElementById('visual-finish-time');
    if (finishEl) {
        finishEl.innerHTML = formatTimeWithDay(startTotalMins, lastOffset + lastDuration);
    }
}

// Helper to format time with "+1 day" badges and convert "750 minutes" -> "12:30 PM"
function formatTimeWithDay(startTotalMins, totalMinutesFromStart) {
    const absoluteMins = startTotalMins + totalMinutesFromStart;

    // Calculate days passed
    // 1440 mins = 24 hours
    const daysPassed = Math.floor(absoluteMins / 1440);

    // Calculate clock time
    let currentMins = absoluteMins % 1440;
    let h = Math.floor(currentMins / 60);
    let m = currentMins % 60;

    const ampm = h >= 12 ? 'p.m.' : 'a.m.';

    h = h % 12;
    h = h ? h : 12; // the hour '0' should be '12'

    // Zero padding for minutes
    const mStr = m < 10 ? '0' + m : m;

    // Zero padding for hours
    const hStr = h < 10 ? '0' + h : h;

    let timeStr = `${hStr}:${mStr} ${ampm}`;

    // Append day badge if needed
    if (daysPassed > 0) {
        timeStr += ` <span class="day-badge">+${daysPassed}d</span>`;
    }

    return timeStr;
}

function toggleTimeline() {
    const box = document.getElementById('timeline-container');
    box.classList.toggle('collapsed');
}

document.addEventListener('DOMContentLoaded', () => updateTimeline());
</script>
{% endif %}

<script>
// Add hover preview for component links
document.querySelectorAll('.component-link').forEach(link => {
    const isDesktop = window.matchMedia("(pointer: fine)").matches;

    if (isDesktop) {
        link.addEventListener('mouseenter', async function() {
            // Create tooltip if it doesn't exist
            let tooltip = document.getElementById('recipe-preview-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'recipe-preview-tooltip';
                document.body.appendChild(tooltip);
            }

            // Position it
            const rect = this.getBoundingClientRect();
            tooltip.style.left = `${rect.left}px`;
            tooltip.style.top = `${rect.bottom + 5}px`;
            tooltip.style.display = 'block';
            tooltip.innerHTML = 'Loading...';

            // Fetch the linked page
            try {
                const response = await fetch(this.href);
                const text = await response.text();

                // Parse the response to grab just the ingredients list
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');

                // Assuming your ingredients are in a container with class 'recipe-ingredients'
                const ingredients = doc.querySelector('.recipe-ingredients ul').innerHTML;
                const title = doc.querySelector('h1').innerText;
                const imageURL = extractBackgroundUrl(doc, '.hero-image');

                tooltip.innerHTML = `<strong>${title}</strong><img src=${imageURL} />`;
                // tooltip.innerHTML = `<strong>${title}</strong><img src=${imageURL} /><ul>${ingredients}</ul>`;
            } catch (e) {
                tooltip.innerHTML = 'Error loading preview.';
            }
        });

        link.addEventListener('mouseleave', () => {
            const tooltip = document.getElementById('recipe-preview-tooltip');
            if (tooltip) tooltip.style.display = 'none';
        });
    } else {
        console.log("Not a fine pointer device, 'mouseenter' event listener not attached.");
    }
});

function extractBackgroundUrl(doc, el) {
    const element = doc.querySelector(el);
    const backgroundImage = element.style.backgroundImage;
    const url = backgroundImage.slice(61, -1).replace(/['"]/g, "");
    return url;
}
</script>

<script>
// Blueprint recipes
document.addEventListener('DOMContentLoaded', () => {
    const yamlBlock = document.getElementById('variation-yaml');
    if (!yamlBlock) return;

    const rawText = yamlBlock.innerText;
    const variations = {};

    // Split by the separator "---" to get each theme block
    const blocks = rawText.split('---');

    blocks.forEach(block => {
        if (!block.trim()) return; // Skip empty blocks

        const currentThemeData = {};
        let themeName = null;

        // Split by lines
        const lines = block.trim().split('\n');

        lines.forEach(line => {
            // Find the first colon to separate Key and Value
            const separatorIndex = line.indexOf(':');
            if (separatorIndex === -1) return; // Skip invalid lines

            const key = line.substring(0, separatorIndex).trim();
            const value = line.substring(separatorIndex + 1).trim();

            if (key === 'Theme') {
                themeName = value;
            } else {
                currentThemeData[key] = value;
            }
        });

        if (themeName) {
            variations[themeName] = currentThemeData;
        }
    });

    // build the UI Controls
    const controlContainer = document.getElementById('variation-controls');
    controlContainer.innerHTML = '<span class="vibe-label">Choose your Vibe</span>';
    console.log("here");

    const btnGroup = document.createElement('div');
    btnGroup.className = 'vibe-buttons';

    // create a "Blueprint" (Reset) button
    const resetBtn = document.createElement('button');
    resetBtn.innerText = 'Blueprint';
    resetBtn.className = 'vibe-btn active';
    resetBtn.onclick = () => applyVariation(null, resetBtn);
    btnGroup.appendChild(resetBtn);

    // create buttons for each theme
    Object.keys(variations).forEach(theme => {
        const btn = document.createElement('button');
        btn.innerText = theme;
        btn.className = 'vibe-btn';
        btn.onclick = () => applyVariation(theme, btn);
        btnGroup.appendChild(btn);
    });

    controlContainer.appendChild(btnGroup);

    let blueprintsInitialized = false;

    function applyVariation(themeName, clickedBtn) {
        // update Buttons Visual State
        document.querySelectorAll('.vibe-btn').forEach(b => b.classList.remove('active'));
        if (clickedBtn) clickedBtn.classList.add('active');

        // Find placeholders in the DOM
        if (!blueprintsInitialized) {
            const contentArea = document.querySelector('.recipe-container');
            if (contentArea) {
                const walker = document.createTreeWalker(contentArea, NodeFilter.SHOW_TEXT, null, false);
                let node;
                // split the string so Pelican/Jinja doesn't try to parse it
                const startBracket = '{' + '{';

                while(node = walker.nextNode()) {
                    if (node.nodeValue.includes(startBracket)) {
                        const parent = node.parentNode;
                        // Save original text if not already saved
                        if (!parent.hasAttribute('data-blueprint')) {
                            parent.setAttribute('data-blueprint', node.nodeValue);
                            parent.classList.add('dynamic-slot');
                        }
                    }
                }
                blueprintsInitialized = true;
            }
        }

        // the update loop
        const slots = document.querySelectorAll('.dynamic-slot');

        slots.forEach(slot => {
            let htmlToUpdate = slot.getAttribute('data-blueprint');

            // Reset parent styling (Assume standard item first)
            if (slot.parentElement && slot.parentElement.tagName === 'LI') {
                slot.parentElement.classList.remove('is-sublist-parent');
            }

            // apply defined replacements
            if (themeName && variations[themeName]) {
                const replacements = variations[themeName];

                Object.keys(replacements).forEach(key => {
                    const regex = new RegExp('{' + '{' + key + '}' + '}', 'g');
                    let value = replacements[key];

                    // If this key exists in the current theme, replace it
                    if (value) {
                        if (key.includes('list')) {
                            // Multi-item List Logic
                            const items = value.split(';').map(item => `<li>${item.trim()}</li>`).join('');
                            value = `<ul class="dynamic-sublist">${items}</ul>`;
                        } else if (key.includes('step')) {
                            // step logic
                            value = `<ol class="dynamic-sublist"><li><strong>${value}</strong></li></ol>`;

                        } else {
                            // Standard Single Item
                            value = `<strong>${value}</strong>`;
                        }

                        htmlToUpdate = htmlToUpdate.replace(regex, value);
                    }
                });
            }

            // This handles "Blueprint Mode" AND any missing variables in specific themes
            const pillRegex = new RegExp('{' + '{([a-zA-Z0-9_]+)}' + '}', 'g');

            htmlToUpdate = htmlToUpdate.replace(pillRegex, (match, key) => {
                const cleanName = key.replace(/_/g, ' ');

                if (key.includes('list') || key.includes('step')) {
                    return `<span class="variable-pill variable-list">${cleanName}</span>`;
                }
                return `<span class="variable-pill">${cleanName}</span>`;
            });

            // parens styling
            if (slot.closest('ul') || slot.closest('.recipe-ingredients')) {
                htmlToUpdate = htmlToUpdate.replace(/\(([^)<]+)\)(?![^<]*>)/g, '<span class="paren">($1)</span>');
                }

            // Render
            slot.innerHTML = htmlToUpdate;
            slot.classList.remove('changed');
            void slot.offsetWidth;
            slot.classList.add('changed');
        });
    }
applyVariation(null, document.querySelector('.vibe-btn.active'));
});
</script>

{% endblock %}
